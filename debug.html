<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>调试版本</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            background: #222;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="info">调试加载中...</div>
    
    <script type='importmap'>
    {
        "imports": {
            "three": "./node_modules/three/build/three.module.js",
            "three/addons/": "./node_modules/three/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        console.log("=== 调试版本启动 ===");
        document.getElementById('info').textContent = 'Three.js初始化中...';

        // 初始化Three.js场景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        camera.position.set(0, 0, 100);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 添加光源
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // 添加坐标轴辅助器
        const axesHelper = new THREE.AxesHelper(50);
        scene.add(axesHelper);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // 添加测试几何体
        console.log("添加测试几何体...");
        
        // 1. 立方体
        const cubeGeometry = new THREE.BoxGeometry(20, 20, 20);
        const cubeMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
        const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        cube.position.set(-30, 0, 0);
        scene.add(cube);
        
        // 2. 球体
        const sphereGeometry = new THREE.SphereGeometry(15, 32, 32);
        const sphereMaterial = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(30, 0, 0);
        scene.add(sphere);
        
        // 3. 测试从服务器获取数据
        async function testDataFetch() {
            try {
                console.log("测试数据获取...");
                document.getElementById('info').textContent = '测试数据获取...';
                
                let response = await fetch('http://localhost:4001/outline');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                let data = await response.json();
                console.log("服务器数据:", data);
                
                if (data && data.success && data.outlinePoints) {
                    document.getElementById('info').textContent = `数据获取成功: ${data.outlinePoints.length}个点`;
                    
                    // 显示前5个点
                    console.log("前5个点:", data.outlinePoints.slice(0, 5));
                    
                } else {
                    document.getElementById('info').textContent = '数据格式错误或无数据';
                }
                
            } catch (error) {
                console.error("数据获取失败:", error);
                document.getElementById('info').textContent = '数据获取失败: ' + error.message;
            }
        }

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize);

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 旋转测试几何体
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;
            sphere.rotation.x += 0.02;
            sphere.rotation.y += 0.01;
            
            controls.update();
            renderer.render(scene, camera);
        }

        console.log("Three.js场景初始化完成");
        document.getElementById('info').textContent = 'Three.js场景已初始化，应该能看到红色立方体和绿色球体';

        // 启动
        animate();
        testDataFetch();
        
    </script>
</body>
</html>